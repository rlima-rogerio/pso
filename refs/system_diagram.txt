╔══════════════════════════════════════════════════════════════════════════════╗
║                    PSO DATA ACQUISITION SYSTEM ARCHITECTURE                  ║
╚══════════════════════════════════════════════════════════════════════════════╝

┌────────────────────────────────────────────────────────────────────────────┐
│                              SENSOR INPUTS                                 │
├────────────────────────────────────────────────────────────────────────────┤
│                                                                            │
│  Accelerometer (3-axis)          Strain Gauge         Motor Sensors        │
│  ┌────────────────┐             ┌──────────┐         ┌─────────────┐       │
│  │ ADXL335        │             │ Thrust   │         │  Voltage    │       │
│  │ X: PD1 (AIN6)  │             │ PD0(AIN7)│         │  PE1 (AIN2) │       │
│  │ Y: PD2 (AIN5)  │             └──────────┘         └─────────────┘       │
│  │ Z: PD3 (AIN4)  │                                  ┌─────────────┐       │
│  └────────────────┘             Hall Sensor          │  Current    │       │
│                                  ┌──────────┐        │  PE2 (AIN1) │       │
│                                  │ RPM      │        └─────────────┘       │
│                                  │ PC6(WT1) │                              │
│                                  └──────────┘                              │
└────────────────────────────────────────────────────────────────────────────┘
                                        │
                                        │ Analog/Digital Signals
                                        ▼
┌────────────────────────────────────────────────────────────────────────────┐
│                          HARDWARE PERIPHERALS                              │
├────────────────────────────────────────────────────────────────────────────┤
│                                                                            │
│  ┌────────────────────┐         ┌────────────────────┐                     │
│  │   ADC0 (12-bit)    │         │   ADC1 (12-bit)    │                     │
│  │ ┌────────────────┐ │         │ ┌────────────────┐ │                     │
│  │ │ Seq 1: 3 chans │ │         │ │ Seq 1: 3 chans │ │                     │
│  │ │ • PD1 (Accel-X)│ │         │ │ • PD2 (Accel-Y)│ │                     │
│  │ │ • PD0 (Thrust) │ │         │ │ • PD3 (Accel-Z)│ │                     │
│  │ │ • PE1 (V_motor)│ │         │ │ • PE2 (I_motor)│ │                     │
│  │ └────────────────┘ │         │ └────────────────┘ │                     │
│  │  Triggered by:     │         │  Triggered by:     │                     │
│  │  Timer0 @ 5 kHz    │         │  Timer0 @ 5 kHz    │                     │
│  └────────────────────┘         └────────────────────┘                     │
│           │                              │                                 │
│           │ ISR (5000 Hz)                │ ISR (5000 Hz)                   │
│           ▼                              ▼                                             │
│  ┌──────────────────────────────────────────────┐                          │
│  │         ADC Interrupt Handler                │                          │
│  │  • Reads 6 samples (3 from each ADC)         │                          │
│  │  • Stores in volatile buffers                │                          │
│  │  • Sets g_timer_a0_scan_flag                 │                          │
│  │  • Execution time: ~5 µs                     │                          │
│  └──────────────────────────────────────────────┘                          │
│                                                                            │
│  ┌────────────────────┐         ┌────────────────────┐                     │
│  │  WTimer1A (32-bit) │         │   Timer3A          │                     │
│  │ ┌────────────────┐ │         │ ┌────────────────┐ │                     │
│  │ │ Edge Counter   │ │         │ │ Periodic: 10Hz │ │                     │
│  │ │ PC6 Input      │ │         │ │ (100ms period) │ │                     │
│  │ │ No interrupts  │ │         │ └────────────────┘ │                     │
│  │ │ Counts pulses  │ │         │  Triggers ISR:     │                     │
│  │ └────────────────┘ │         │  • Read WTimer1A   │                     │
│  └────────────────────┘         │  • Calculate RPM   │                     │
│                                 │  • Handle overflow │                     │
│                                 └────────────────────┘                     │
│                                           │                                │
│                                           │ ISR (10 Hz)                    │
│                                           ▼                                │
│  ┌──────────────────────────────────────────────┐                          │
│  │        Timer3A Interrupt Handler             │                          │
│  │  • pulse_diff = current_count - last_count   │                          │
│  │  • RPM = (pulse_diff × 600) / BLADE_NUMBER   │                          │
│  │  • Sets g_timer_a3_scan_flag                 │                          │
│  │  • Execution time: ~10 µs                    │                          │
│  └──────────────────────────────────────────────┘                          │
│                                                                            │
│  ┌────────────────────┐                                                    │
│  │  WTimer1B (PWM)    │                                                    │
│  │ ┌────────────────┐ │                                                    │
│  │ │ 50 Hz PWM      │ │                                                    │
│  │ │ PC7 Output     │ ────────────► ESC (Electronic Speed Controller)      │
│  │ │ 1-2ms pulse    │ │                                                    │
│  │ └────────────────┘ │                                                    │
│  └────────────────────┘                                                    │
│                                                                            │
│  ┌────────────────────┐                                                    │
│  │  SysTick Timer     │                                                    │
│  │ ┌────────────────┐ │                                                    │
│  │ │ 1ms period     │ │                                                    │
│  │ │ 1 kHz rate     │ │                                                    │
│  │ │ g_system_tick  │ │                                                    │
│  │ └────────────────┘ │                                                    │
│  └────────────────────┘                                                    │
└────────────────────────────────────────────────────────────────────────────┘
                                        │
                                        │ Data flows to software
                                        ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                            SOFTWARE LAYER                                   │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌────────────────────────────────────────────────────────────────────────┐ │
│  │                      MAIN LOOP (1 kHz via SysTick)                     │ │
│  │  ┌─────────────────────────────────────────────────────────────────┐   │ │
│  │  │                   STATE MACHINE                                 │   │ │
│  │  │                                                                 │   │ │
│  │  │  [INIT] ──► [IDLE] ──► [TIMING] ──► [PROCESSING]               │   │ │
│  │  │                ▲           │              │                     │  │ │
│  │  │                │           │              ▼                     │  │ │
│  │  │                │      1ms Timer     [STREAMING]                 │  │ │
│  │  │                │           │              │                      │  │ │
│  │  │                │           │              ▼                      │  │ │
│  │  │          [STOPPING] ◄─────┴────── [PWM_CONTROL]                │  │ │
│  │  │                │                          │                      │  │ │
│  │  │                └──────────────────────────┘                      │  │ │
│  │  │                                                                  │  │ │
│  │  └─────────────────────────────────────────────────────────────────┘  │ │
│  │                                                                         │ │
│  │  State Functions:                                                       │ │
│  │  • state_idle()       - Wait for SW1 press                             │ │
│  │  • state_timing()     - 1ms loop rate control                          │ │
│  │  • state_processing() - Scale data, calc RPM, pack packet             │ │
│  │  • state_streaming()  - UART transmission @ 500 Hz                     │ │
│  │  • state_pwm_control()- Execute PWM profiles                           │ │
│  │  • state_stopping()   - Cleanup and return to idle                     │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │                    DATA PROCESSING PIPELINE                            │ │
│  │                                                                         │ │
│  │  1. ADC Raw Values (adc0_buffer[], adc1_buffer[])                     │ │
│  │           │                                                             │ │
│  │           ▼                                                             │ │
│  │  2. Scale & Convert (physical units)                                   │ │
│  │           │                                                             │ │
│  │           ▼                                                             │ │
│  │  3. Calculate RPM (rpm_calculate())                                    │ │
│  │           │                                                             │ │
│  │           ▼                                                             │ │
│  │  4. Pack Data (packet_data(), copy_data())                             │ │
│  │           │                                                             │ │
│  │           ▼                                                             │ │
│  │  5. Store in FIFO (fifo_put())                                         │ │
│  │           │                                                             │ │
│  │           ▼                                                             │ │
│  │  6. UART Transmission (uartBatchWrite())                               │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │                        FIFO BUFFERS                                    │ │
│  │  ┌──────────────────┐              ┌──────────────────┐               │ │
│  │  │  g_fifo_ping     │              │  g_fifo_pong     │               │ │
│  │  │  (4096 bytes)    │  ◄───────►   │  (4096 bytes)    │               │ │
│  │  │                  │  Ping-Pong   │                  │               │ │
│  │  │  Producer: ISR   │  Buffering   │  Consumer: Main  │               │ │
│  │  └──────────────────┘              └──────────────────┘               │ │
│  │         ▲                                    │                          │ │
│  │         │ fifo_put()                         │ fifo_get()              │ │
│  │         │                                    ▼                          │ │
│  └─────────┼───────────────────────────────────────────────────────────┘ │
│            │                                                                │
└────────────┼────────────────────────────────────────────────────────────────┘
             │
             │ UART TX
             ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                            OUTPUT / INTERFACE                                │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌────────────────────┐         ┌────────────────────┐                     │
│  │  UART0 (115200)    │         │  User Interface    │                     │
│  │ ┌────────────────┐ │         │ ┌────────────────┐ │                     │
│  │ │ TX: PA1        │ │────────►│ │ LED RGB (PF1-3)│ │                     │
│  │ │ RX: PA0        │ │         │ │ • State indic. │ │                     │
│  │ │ VCP (USB)      │ │         │ │ • Activity     │ │                     │
│  │ └────────────────┘ │         │ └────────────────┘ │                     │
│  │                    │         │ ┌────────────────┐ │                     │
│  │  Packet Format:    │         │ │ Buttons        │ │                     │
│  │  [STX][LEN][DATA]  │         │ │ • SW1: Start   │ │                     │
│  │  [CHECKSUM]        │         │ │ • SW2: Stop    │ │                     │
│  │  (21 bytes total)  │         │ └────────────────┘ │                     │
│  │                    │         │                    │                     │
│  │  Data Rate:        │         │ Debug GPIO (PD4-7) │                     │
│  │  500 packets/sec   │         │ • Oscilloscope     │                     │
│  │  84 kbps (73%)     │         │ • Timing analysis  │                     │
│  └────────────────────┘         └────────────────────┘                     │
│            │                                                                 │
│            ▼                                                                 │
│  ┌────────────────────┐                                                     │
│  │   HOST PC          │                                                     │
│  │ • Data logging     │                                                     │
│  │ • Visualization    │                                                     │
│  │ • Control commands │                                                     │
│  └────────────────────┘                                                     │
└─────────────────────────────────────────────────────────────────────────────┘

╔══════════════════════════════════════════════════════════════════════════════╗
║                         TIMING DIAGRAM (1 second)                             ║
╚══════════════════════════════════════════════════════════════════════════════╝

Main Loop (1 kHz):     ║ ║ ║ ║ ║ ║ ║ ║ ║ ║ ║ ║ ║ ║ ║ ║ ║ ║ ║ ║ ║ ║ ... (1000×)
                       ▲ ▲ ▲ ▲ ▲ ▲ ▲ ▲ ▲ ▲ ▲ ▲ ▲ ▲ ▲ ▲ ▲ ▲ ▲ ▲ ▲ ▲ 
                       └─1ms─┘

ADC Sampling (5 kHz):  |||||||||||||||||||||||||||||||||||||||||||||... (5000×)
                       ▲▲▲▲▲
                       └200µs─┘

UART Streaming (500Hz): ▓  ▓  ▓  ▓  ▓  ▓  ▓  ▓  ▓  ▓  ▓  ▓  ▓  ... (500×)
                        ▲  ▲  ▲
                        └─2ms──┘

RPM Calculation (10Hz): ■         ■         ■         ■         ■... (10×)
                        ▲         ▲
                        └───100ms──┘

PWM Update (Variable):  ●     ●     ●     ●     ●     ●     ●  ... (depends)

═══════════════════════════════════════════════════════════════════════════════

Legend:
  ║ = Main loop iteration (1ms)
  | = ADC sample (200µs)
  ▓ = UART packet transmission (2ms)
  ■ = RPM calculation (100ms)
  ● = PWM profile update (variable)

CPU Usage Breakdown:
  Main Loop:      15%  ████████████████
  ADC ISR:        2.5% ███
  UART Streaming: 5%   ██████
  RPM Calc:      <0.1% ▓
  PWM Updates:   <1%   █
  Idle:          76.4% ████████████████████████████████████████████████████████

═══════════════════════════════════════════════════════════════════════════════
